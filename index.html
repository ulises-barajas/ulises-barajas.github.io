import { useEffect, useRef } from "react";
import { Mail, Linkedin, Globe, FileText, BookOpen, Award, Layers, GraduationCap, Github, Pencil, BookMarked } from "lucide-react";

// Página de CV con fondo "dinámica de fluidos" en movimiento continuo (WebGL)
// - Diseño moderno tipo glassmorphism, accesible y responsive
// - Sin dependencias externas adicionales
// - Edita el JSON "data" para actualizar tu información

export default function CVWaterFlow() {
  const canvasRef = useRef(null);
  const rafRef = useRef(0);
  const glRef = useRef(null);
  const programRef = useRef(null);

  // === Datos del CV (edítalos a tu gusto) ===
  const data = {
    nombre: "Ing. Ulises Absalom Barajas Madrigal",
    titular: "Maestría en Ingeniería de los Recursos Hídricos · Ingeniero Civil",
    resumen:
      "Divulgador y joven investigador en hidrología, modelación de recursos hídricos y SIG. Me apasiona convertir datos complejos en decisiones claras y soluciones reales, combinando ciencia, programación y comunicación.",
    contacto: {
      emailPersonal: "ulises.absalom.barajas@gmail.com",
      emailInstitucional: "1595216d@umich.mx",
      web: "https://sites.google.com/view/ulises-barajas/inicio",
      linkedin: "https://www.linkedin.com/in/ulises-absalom-barajas-madrigal-a69b99336/",
      researchgate: "https://www.researchgate.net/profile/Ulises-Barajas-Madrigal",
    },
    highlights: [
      { label: "Artículo JCR", value: "1" },
      { label: "Capítulo de libro", value: "1" },
      { label: "Ponencias", value: "5" },
      { label: "Cursos/Materia impartidos", value: "3" },
    ],
    habilidades: {
      lenguajes: ["Python", "R", "MATLAB", "LaTeX"],
      ofimatica: ["Word", "Excel", "PowerPoint", "OneNote", "Access"],
      software: [
        "AutoCAD", "CivilCAD", "SAP2000", "ArcGIS", "QGIS", "Global Mapper", "Google Earth",
        "HEC-RAS", "HEC-HMS", "Hidroesta", "Hcanales", "ModelMuse", "Processing MODFLOW",
        "HBV-Light", "AQUATOOL", "VS Code"
      ],
      idiomas: ["Inglés avanzado (habla, lectura y escritura)"]
    },
    produccion: {
      articulos: [
        {
          titulo:
            "Evaluación de los recursos hídricos en el acuífero 'Área Metropolitana de Monterrey' en la última década y sus implicaciones en la crisis hídrica de la zona",
          revista: "Ciencia Nicolaita 91:69–82 (2024)",
          doi: "https://doi.org/10.35830/cn.vi91.791",
          autores: "U. A. Barajas-Madrigal, J. J. Madrigal-Barrera, L. García-Romero, S. T. Sánchez-Quispe",
        },
      ],
      capitulos: [
        {
          titulo:
            "Comparativo del rendimiento de los modelos lluvia-escurrimiento HBV y SAC-SMA en la cuenca del río Tepalcatepec",
          libro: "Transformando el ciclo del agua. El reúso es responsabilidad de todos (AMH, 2025), cap. 12",
          isbn: "978-607-97532-3-8",
          autores: "U. A. Barajas-Madrigal, J. J. Madrigal-Barrera, S. T. Sánchez-Quispe",
        },
      ],
      ponencias: [
        {
          titulo:
            "Determinación y Análisis de los Niveles Piezométricos en el Acuífero 'Área Metropolitana de Monterrey'",
          evento: "11° Verano Nicolaita de Investigación",
          lugar: "Morelia, México",
          anio: "2023",
        },
        {
          titulo:
            "Evaluación de los Recursos Hídricos en el Acuífero 'Área Metropolitana de Monterrey' y sus Implicaciones en la Crisis Hídrica de la Zona",
          evento: "1° Congreso de Gestión Integral de Recursos Hídricos",
          lugar: "Morelia, México",
          anio: "2023",
        },
        {
          titulo: "Evaluación de la Recarga del Acuífero 'Área Metropolitana de Monterrey'",
          evento: "10° Verano Nicolaita de Investigación",
          lugar: "Morelia, México",
          anio: "2022",
        },
        {
          titulo:
            "Evaluación de las Series Históricas de Infiltración del Acuífero 'Área Metropolitana de Monterrey'",
          evento:
            "17° Congreso Estatal de Ciencia, Tecnología e Innovación y 11° Encuentro de Jóvenes Investigadores del Estado de Michoacán",
          lugar: "Morelia, México",
          anio: "2022",
        },
        {
          titulo:
            "Evaluación de las Infiltraciones del Acuífero 'Área Metropolitana de Monterrey'",
          evento: "Seminario Gestión Integral del Agua 2022",
          lugar: "Morelia, México",
          anio: "2022",
        },
      ],
    },
    docencia: [
      {
        titulo: "Materia de Hidrología Superficial",
        institucion: "Facultad de Ingeniería Civil, UMSNH",
        lugar: "Morelia, México",
        anio: "2024",
      },
      {
        titulo: "Curso: Procesamiento y Validación de Datos Hidrometeorológicos (40 h)",
        institucion: "Maestría en IRH, UMSNH",
        lugar: "Morelia, México",
        anio: "2024",
      },
      {
        titulo: "Curso: ArcGIS Enfocado en Hidrología y Delimitación de Zonas de Inundación (40 h)",
        institucion: "Maestría en IRH, UMSNH",
        lugar: "Morelia, México",
        anio: "2022",
      },
    ],
    cursos: [
      { anio: "2023", titulo: "Lineamientos para el Desarrollo de Artículos Científicos (20 h)", institucion: "UMSNH" },
      { anio: "2023", titulo: "Modelación de Acuíferos con MODFLOW en ProcessingMODFLOW y ModelMuse (20 h)", institucion: "UMSNH" },
      { anio: "2023", titulo: "Validación de Información Hidrometeorológica (20 h)", institucion: "UMSNH" },
      { anio: "2022", titulo: "Modelos Hidrológicos Superficiales (20 h)", institucion: "UMSNH" },
      { anio: "2022", titulo: "Uso de Herramientas SIG en QGIS (20 h)", institucion: "UMSNH" },
      { anio: "2022", titulo: "Redacción de Artículos Científicos (20 h)", institucion: "UMSNH" },
      { anio: "2022", titulo: "Análisis y Validación de Datos Meteorológicos e Hidrométricos (20 h)", institucion: "UMSNH" },
      { anio: "2021", titulo: "SIATL, SIG y Agisoft Metashape básico (32 h)", institucion: "Aprende – Eje corp." },
    ],
    educacion: [
      {
        periodo: "2024–2026",
        grado: "Maestría en Ingeniería de los Recursos Hídricos",
        institucion: "Universidad Michoacana de San Nicolás de Hidalgo",
        tesis:
          "Desarrollo y Aplicación de un Sistema de Modelación Conjunta para la Gestión de los Recursos Hídricos de la Cuenca del Río Tepalcatepec ante Eventos de Sequía",
      },
      {
        periodo: "2018–2023",
        grado: "Licenciatura en Ingeniería Civil",
        institucion: "Universidad Michoacana de San Nicolás de Hidalgo",
        tesis:
          "Evaluación de los Recursos Hídricos en el Acuífero 'Área Metropolitana de Monterrey'",
      },
    ],
  };

  // === WebGL shader de fondo (flujo tipo fluido) ===
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const gl = canvas.getContext("webgl", { antialias: false, depth: false, stencil: false, premultipliedAlpha: true });
    if (!gl) return;
    glRef.current = gl;

    const vertex = `
      attribute vec2 a_pos; varying vec2 v_uv; void main(){ v_uv = a_pos * 0.5 + 0.5; gl_Position = vec4(a_pos, 0.0, 1.0); }
    `;

    const fragment = `
      precision highp float; varying vec2 v_uv; uniform vec2 u_res; uniform float u_time;
      float hash(vec2 p){ p = fract(p*vec2(123.34,345.45)); p += dot(p,p+34.345); return fract(p.x*p.y); }
      float noise(vec2 p){ vec2 i=floor(p), f=fract(p); vec2 u=f*f*f*(f*(f*6.-15.)+10.); float a=hash(i+vec2(0,0)); float b=hash(i+vec2(1,0)); float c=hash(i+vec2(0,1)); float d=hash(i+vec2(1,1)); return mix(mix(a,b,u.x), mix(c,d,u.x), u.y); }
      float fbm(vec2 p){ float v=0., a=0.5; mat2 m=mat2(1.6,1.2,-1.2,1.6); for(int i=0;i<6;i++){ v+=a*noise(p); p=m*p; a*=0.5; } return v; }
      vec2 flow(vec2 p){ float n1=fbm(p+vec2(0.,1.)); float n2=fbm(p+vec2(1.,0.)); float dx=n1-fbm(p-vec2(0.,1.)); float dy=n2-fbm(p-vec2(1.,0.)); return vec2(dy,-dx); }
      vec3 palette(float t){ vec3 a=vec3(0.05,0.20,0.35), b=vec3(0.10,0.55,0.80), c=vec3(0.20,0.90,0.80), d=vec3(0.00,0.25,0.50); return a + b*cos(6.28318*(c*t + d)); }
      void main(){ vec2 uv=v_uv; vec2 p=uv*2.-1.; p.x*=u_res.x/u_res.y; float t=u_time*0.08; vec2 q=p*1.2; vec2 f1=flow(q+t); vec2 f2=flow(q*0.75 - t*0.7); vec2 w=q + 0.7*f1 + 0.35*f2; float v=mix(fbm(w*1.2 + t*0.5), fbm(w*2.5 - t*0.9), 0.6); vec3 col=palette(v*0.9+0.1);
        vec2 px=1.0/u_res; vec3 acc=col*4.; acc+=palette(fbm((w+vec2(px.x,0.))*1.2 + t*0.5)); acc+=palette(fbm((w-vec2(px.x,0.))*1.2 + t*0.5)); acc+=palette(fbm((w+vec2(0.,px.y))*1.2 + t*0.5)); acc+=palette(fbm((w-vec2(0.,px.y))*1.2 + t*0.5)); acc+=palette(fbm((w+px)*1.2 + t*0.5)); acc+=palette(fbm((w-px)*1.2 + t*0.5)); acc+=palette(fbm((w+vec2(px.x,-px.y))*1.2 + t*0.5)); acc+=palette(fbm((w+vec2(-px.x,px.y))*1.2 + t*0.5)); col=acc/12.; float vign=smoothstep(1.2,0.2,length(p)); col*=mix(0.9,1.05,vign); gl_FragColor=vec4(col,1.0); }
    `;

    function createShader(type, source){ const sh=gl.createShader(type)!; gl.shaderSource(sh, source); gl.compileShader(sh); if(!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(sh) || "Shader error"); return sh; }
    function createProgram(vsSrc, fsSrc){ const vs=createShader(gl.VERTEX_SHADER, vsSrc); const fs=createShader(gl.FRAGMENT_SHADER, fsSrc); const prog=gl.createProgram()!; gl.attachShader(prog, vs); gl.attachShader(prog, fs); gl.linkProgram(prog); if(!gl.getProgramParameter(prog, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(prog) || "Link error"); gl.deleteShader(vs); gl.deleteShader(fs); return prog; }

    const program = createProgram(vertex, fragment);
    programRef.current = program;

    const a_pos = gl.getAttribLocation(program, "a_pos");
    const u_res = gl.getUniformLocation(program, "u_res");
    const u_time = gl.getUniformLocation(program, "u_time");

    const buffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, -1,1, 1,-1, 1,1]), gl.STATIC_DRAW);

    gl.useProgram(program);
    gl.enableVertexAttribArray(a_pos);
    gl.vertexAttribPointer(a_pos, 2, gl.FLOAT, false, 0, 0);

    function resize(){
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      const w = Math.max(1, Math.floor(canvas.clientWidth * dpr));
      const h = Math.max(1, Math.floor(canvas.clientHeight * dpr));
      if (canvas.width !== w || canvas.height !== h) { canvas.width = w; canvas.height = h; gl.viewport(0, 0, w, h); }
      gl.uniform2f(u_res, w, h);
    }
    const ro = new ResizeObserver(resize); ro.observe(canvas); resize();

    let start = performance.now();
    function frame(now){ gl.uniform1f(u_time, (now - start)/1000); gl.drawArrays(gl.TRIANGLES, 0, 6); rafRef.current = requestAnimationFrame(frame); }
    rafRef.current = requestAnimationFrame(frame);

    return () => { cancelAnimationFrame(rafRef.current); ro.disconnect(); if(programRef.current) gl.deleteProgram(programRef.current); const buf=gl.getParameter(gl.ARRAY_BUFFER_BINDING); if(buf) gl.deleteBuffer(buf); };
  }, []);

  return (
    <div className="relative min-h-screen w-full overflow-x-hidden">
      {/* Fondo */}
      <canvas ref={canvasRef} className="fixed inset-0 w-full h-full" style={{ background: "linear-gradient(135deg,#0a1f33,#0f3a55)" }} />

      {/* Overlay contenido */}
      <main className="relative z-10">
        {/* HERO */}
        <section className="px-6 md:px-10 lg:px-16 pt-16 pb-10">
          <div className="max-w-6xl mx-auto">
            <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-3xl p-8 md:p-12 shadow-2xl">
              <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                  <h1 className="text-3xl md:text-5xl font-semibold text-white drop-shadow-sm">{data.nombre}</h1>
                  <p className="mt-2 text-white/80 text-lg">{data.titular}</p>
                  <p className="mt-4 text-white/80 max-w-2xl">{data.resumen}</p>
                  <div className="mt-6 flex flex-wrap gap-3">
                    <a href={`mailto:${data.contacto.emailPersonal}`} className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/15 hover:bg-white/25 text-white transition border border-white/10"><Mail size={18}/>Correo personal</a>
                    <a href={`mailto:${data.contacto.emailInstitucional}`} className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-white transition border border-white/10"><Mail size={18}/>Correo institucional</a>
                    <a href={data.contacto.linkedin} target="_blank" className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-white transition border border-white/10"><Linkedin size={18}/>LinkedIn</a>
                    <a href={data.contacto.researchgate} target="_blank" className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-white transition border border-white/10"><BookOpen size={18}/>ResearchGate</a>
                    <a href={data.contacto.web} target="_blank" className="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/20 text-white transition border border-white/10"><Globe size={18}/>Sitio</a>
                  </div>
                </div>
                <ul className="grid grid-cols-2 sm:grid-cols-4 gap-3 w-full md:w-auto">
                  {data.highlights.map((h, i) => (
                    <li key={i} className="text-center px-4 py-3 rounded-2xl bg-white/10 border border-white/10 text-white">
                      <div className="text-3xl font-semibold leading-none">{h.value}</div>
                      <div className="text-xs mt-1 opacity-80">{h.label}</div>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        </section>

        {/* HABILIDADES */}
        <section className="px-6 md:px-10 lg:px-16 pb-6">
          <div className="max-w-6xl mx-auto grid md:grid-cols-3 gap-6">
            <Card title="Lenguajes y escritura científica" icon={<Pencil className="opacity-90"/>} items={data.habilidades.lenguajes} />
            <Card title="Ofimática" icon={<FileText className="opacity-90"/>} items={data.habilidades.ofimatica} />
            <Card title="Software técnico" icon={<Layers className="opacity-90"/>} items={data.habilidades.software} />
            <Card title="Idiomas" icon={<BookMarked className="opacity-90"/>} items={data.habilidades.idiomas} />
          </div>
        </section>

        {/* PRODUCCIÓN CIENTÍFICA */}
        <section className="px-6 md:px-10 lg:px-16 py-6">
          <div className="max-w-6xl mx-auto grid lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              <SectionTitle icon={<Award/>} title="Artículos"/>
              {data.produccion.articulos.map((p, i) => (
                <Item key={i} title={p.titulo} meta={`${p.revista} · ${p.autores}`} linkLabel="DOI" linkHref={p.doi} />
              ))}
              <SectionTitle icon={<BookOpen/>} title="Capítulos de libro"/>
              {data.produccion.capitulos.map((p, i) => (
                <Item key={i} title={p.titulo} meta={`${p.libro} · ${p.autores}`} />
              ))}
            </div>
            <div className="space-y-4">
              <SectionTitle icon={<GraduationCap/>} title="Memorias y ponencias"/>
              {data.produccion.ponencias.map((p, i) => (
                <Item key={i} title={p.titulo} meta={`${p.evento} · ${p.lugar} · ${p.anio}`} />
              ))}
            </div>
          </div>
        </section>

        {/* DOCENCIA Y CURSOS IMPARTIDOS */}
        <section className="px-6 md:px-10 lg:px-16 py-6">
          <div className="max-w-6xl mx-auto">
            <SectionTitle icon={<Github/>} title="Docencia y cursos impartidos"/>
            <div className="grid md:grid-cols-2 gap-4 mt-4">
              {data.docencia.map((d, i) => (
                <Item key={i} title={d.titulo} meta={`${d.institucion} · ${d.lugar} · ${d.anio}`} />
              ))}
            </div>
          </div>
        </section>

        {/* CURSOS DE ACTUALIZACIÓN */}
        <section className="px-6 md:px-10 lg:px-16 py-6">
          <div className="max-w-6xl mx-auto">
            <SectionTitle icon={<Layers/>} title="Cursos de actualización profesional"/>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
              {data.cursos.map((c, i) => (
                <Item key={i} title={c.titulo} meta={`${c.institucion} · ${c.anio}`} />
              ))}
            </div>
          </div>
        </section>

        {/* EDUCACIÓN */}
        <section className="px-6 md:px-10 lg:px-16 py-10">
          <div className="max-w-6xl mx-auto">
            <SectionTitle icon={<GraduationCap/>} title="Educación"/>
            <div className="grid md:grid-cols-2 gap-4 mt-4">
              {data.educacion.map((e, i) => (
                <div key={i} className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 text-white">
                  <div className="text-sm opacity-80">{e.periodo}</div>
                  <div className="text-lg font-semibold mt-1">{e.grado}</div>
                  <div className="text-white/80">{e.institucion}</div>
                  {e.tesis && <div className="text-white/70 text-sm mt-2"><span className="font-semibold">Tesis:</span> {e.tesis}</div>}
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* CTA */}
        <section className="px-6 md:px-10 lg:px-16 pb-16">
          <div className="max-w-6xl mx-auto">
            <div className="flex flex-col md:flex-row items-center justify-between gap-4 backdrop-blur-xl bg-white/5 border border-white/10 rounded-3xl p-6 text-white">
              <div>
                <h3 className="text-xl font-semibold">¿Colaboramos?</h3>
                <p className="text-white/80">Proyectos de modelación, análisis de datos climáticos/hidrológicos y divulgación científica.</p>
              </div>
              <div className="flex gap-3">
                <a href={`mailto:${data.contacto.emailPersonal}`} className="px-5 py-3 rounded-2xl bg-white/15 hover:bg-white/25 border border-white/10">Escríbeme</a>
                <a href={data.contacto.web} target="_blank" className="px-5 py-3 rounded-2xl border border-white/10 hover:bg-white/10 inline-flex items-center gap-2"><Globe size={18}/> Portafolio</a>
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer className="relative z-10 px-6 md:px-10 lg:px-16 pb-8 text-center text-white/60">
        © {new Date().getFullYear()} {data.nombre}
      </footer>
    </div>
  );
}

// === Componentes UI auxiliares ===
function SectionTitle({ icon, title }){
  return (
    <div className="flex items-center gap-2 text-white">
      <span className="p-2 rounded-xl bg-white/10 border border-white/10">{icon}</span>
      <h2 className="text-xl md:text-2xl font-semibold drop-shadow-sm">{title}</h2>
    </div>
  );
}

function Item({ title, meta, linkHref, linkLabel }){
  return (
    <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 text-white">
      <div className="font-medium">{title}</div>
      {meta && <div className="text-sm text-white/80 mt-1">{meta}</div>}
      {linkHref && (
        <a href={linkHref} target="_blank" className="inline-block mt-3 text-sm underline underline-offset-4 hover:no-underline">
          {linkLabel || "Enlace"}
        </a>
      )}
    </div>
  );
}

function Card({ title, items, icon }){
  return (
    <div className="backdrop-blur-xl bg-white/5 border border-white/10 rounded-2xl p-5 text-white">
      <div className="flex items-center gap-2">
        <span className="p-2 rounded-xl bg-white/10 border border-white/10">
          {icon}
        </span>
        <h3 className="text-lg font-semibold">{title}</h3>
      </div>
      <ul className="mt-3 flex flex-wrap gap-2">
        {items.map((it, i) => (
          <li key={i} className="text-sm px-3 py-1 rounded-xl bg-white/10 border border-white/10">
            {it}
          </li>
        ))}
      </ul>
    </div>
  );
}
